<div data-scope="groups">

	<div class="header">
		<label><i class="fa fa-folder"></i>@(Groups)</label>
		<div>
			<button class="exec" data-exec="?/create"><i class="fa fa-plus-circle green"></i>@(New)</button>
			<button data-bind="?__enabled:value&&((value.checked&&value.checked.length)||value.selected)__track:checked,selected" class="exec" data-exec="?/remove" disabled><i class="fa fa-trash-o red"></i>@(Remove)</button>
		</div>
	</div>

	<div data---="datagrid__?.items__height:.ui-layout-section;noborder:1;highlight:true;click:?.selected;dblclick:?/edit;checked:?.checked;margin:45;button:?/button">
		<script type="text/plain">
			[
				{ name: 'id', text: '@(ID)', width: 200 },
				{ name: 'name', text: '@(Name)', width: 200 },
				{ name: 'note', text: '@(Note)', width: 300, sort: false },
				{ name: 'roles', text: '@(Roles)', width: 350, template: '{{ roles | joinbgcolor(\' \') }}', search: true },
				{ name: 'apps2', text: '@(Applications)', width: 350, template: '{{ apps2 | join }}', search: true, sort: false },
				{ name: 'dtupdated', text: '@(Updated)', width: 120, align: 1, format: '[ts]', filter: false },
				{ name: 'dtcreated', text: '@(Created)', width: 120, align: 1, format: '[ts]', filter: false },
				{ type: 'controls', template: '<button name="edit"><i class="fa fa-pencil mr5"></i>@(Edit)</button><button name="remove"><i class="fa fa-trash-o red"></i></button>' }
			]
		</script>
	</div>
</div>

<div data---="importer__common.form__if:groupsform;url:/forms/group.html"></div>

<script>

	PLUGIN('groups', function(exports) {

		exports.refresh = function() {
			DAPI('groups', function(response) {
				var apps = main.apps;
				for (var i = 0; i < response.length; i++) {
					var item = response[i];
					var tmp = [];

					item.roles = {};
					item.appsroles = {};

					for (var j = 0; j < item.apps.length; j++) {
						var a = item.apps[j];
						var app = apps.findItem('id', a.id);
						if (app) {
							tmp.push(app.name);
							item.appsroles[a.id] = a.roles;
							var roles = item.apps[j];
							for (var k = 0; k < a.roles.length; k++)
								item.roles[a.roles[k]] = 1;
						}
					}

					if (tmp.length)
						tmp.quicksort();

					item.roles = Object.keys(item.roles);

					if (item.roles && item.roles.length)
						item.roles.quicksort();

					item.apps2 = tmp;
				}
				SET('?.items', response);
			});
		};

		exports.reload = function() {
			exports.refresh();
		};

		exports.edit = function(row) {

			if (row instanceof jQuery)
				row = GET('?.selected');

			SET('groupsform @reset', CLONE(row));
			SET('common.form', 'groupsform');
		};

		exports.create = function(row) {
			SET('groupsform @default', { appsroles: {} });
			SET('common.form', 'groupsform');
		};

		exports.button = function(name, row) {
			if (name === 'edit') {
				exports.edit(row);
			} else if (name === 'remove') {
				OP.approve('@(Are you sure you want to remove "{0}"?)'.format(row.name), '"trash-o" @(Remove)', function() {
					DAPI('groups_remove?id=' + encodeURIComponent(row.id), exports.refresh);
				});
			}
		};

		exports.remove = function(el) {
			var checked = GET('?.checked');
			var selected = GET('?.selected');
			var arr;

			if (checked && checked.length)
				arr = checked;
			else if (selected)
				arr = [selected];

			OP.approve('@(Are you sure you want to remove selected groups?)', '"trash-o" @(Remove)', function() {
				OP.loading(true);
				arr.wait(function(item, next, index) {
					OP.progress((index / arr.length) * 100);
					DAPI('groups_remove?id=' + encodeURIComponent(item.id), next);
				}, function() {
					OP.progress(100);
					OP.loading(false, 500);
					exports.scope();
					exports.refresh();
				});
			});
		};

	});
</script>